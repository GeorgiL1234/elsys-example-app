name: CI/CD Pipeline

on:
  # CI - Pull Request
  pull_request:
    branches: [main]

  # CD - Push към main
  push:
    branches: [main]

jobs:
  # Job за CI (unit тестове + кратък load тест)
  ci:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest locust

      # 4️⃣ Run unit tests
      - name: Run unit tests
        run: pytest -v tests/

      # 5️⃣ Run short load test with Locust
      - name: Run Locust load test
        run: |
          locust -f locustfile.py --headless -u 10 -r 5 -t 30s --host http://localhost:8000

  # Job за CD (docker build и tagging)
  cd:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: []

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Log in to DockerHub (optional, if pushing to DockerHub)
      #- name: Log in to DockerHub
      #  uses: docker/login-action@v2
      #  with:
      #    username: ${{ secrets.DOCKER_USERNAME }}
      #    password: ${{ secrets.DOCKER_PASSWORD }}

      # 4️⃣ Build Docker image
      - name: Build Docker image
        run: |
          IMAGE_NAME="elsys-example-app"
          # Docker build
          docker build -t $IMAGE_NAME:latest .
          # Tag image with Git SHA
          GIT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:$GIT_SHA

      # 5️⃣ Optional: Push Docker image to registry
      #- name: Push Docker image
      #  run: |
      #    docker push $IMAGE_NAME:latest
      #    docker push $IMAGE_NAME:$GIT_SHA
